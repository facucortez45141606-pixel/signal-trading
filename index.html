<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Image Analyzer ‚Äî IA Pro</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: "Inter", Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      max-width: 650px;
      margin: 20px auto;
    }
    button {
      background: #38bdf8;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      color: #0f172a;
      transition: 0.2s;
    }
    button:hover { background: #0ea5e9; }
    #result { margin-top: 25px; font-size: 18px; transition: opacity 0.5s; }
    #progress {
      height: 10px;
      background: #1e293b;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
    }
    #bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transition: width 0.3s ease;
    }
    .arrow {
      font-size: 70px;
      margin-top: 10px;
      animation: bounce 1.2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <h1>üìä Trading Image Analyzer ‚Äî IA Pro</h1>
  <div class="card">
    <p>Sube una captura del gr√°fico (velas rojas y verdes).</p>
    <input type="file" id="imageInput" accept="image/*"><br><br>
    <button onclick="startAnalysis()">Analizar</button>
    <div id="progress"><div id="bar"></div></div>
    <div id="result"></div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    let memory = [];

    async function startAnalysis() {
      const input = document.getElementById('imageInput');
      const result = document.getElementById('result');
      const bar = document.getElementById('bar');

      if (!input.files[0]) {
        result.innerHTML = "‚ö†Ô∏è Por favor, sube una imagen primero.";
        return;
      }

      result.innerHTML = "‚è≥ Analizando imagen del mercado...";
      bar.style.width = "0%";

      let progress = 0;
      const interval = setInterval(() => {
        progress += 3;
        bar.style.width = progress + "%";
        if (progress >= 100) clearInterval(interval);
      }, 180); // 6 s total

      const img = new Image();
      img.src = URL.createObjectURL(input.files[0]);

      img.onload = async function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        setTimeout(() => analyzeChart(canvas, result), 6000);
      };
    }

    function analyzeChart(canvas, result) {
      let src = cv.imread(canvas);
      let hsv = new cv.Mat();
      cv.cvtColor(src, hsv, cv.COLOR_RGBA2HSV);

      let channels = new cv.MatVector();
      cv.split(hsv, channels);
      let hue = channels.get(0), sat = channels.get(1), val = channels.get(2);

      const meanHue = cv.mean(hue)[0];
      const meanSat = cv.mean(sat)[0];
      const meanVal = cv.mean(val)[0];

      src.delete(); hsv.delete(); channels.delete();

      // --- IA adaptativa con "memoria" ---
      let greenPower = (meanHue > 40 && meanHue < 90) ? meanSat : 0;
      let redPower = ((meanHue < 20 || meanHue > 160)) ? meanSat : 0;

      const avgMemory = memory.length ? memory.reduce((a,b)=>a+b,0)/memory.length : 0;
      const adaptFactor = 1 + avgMemory * 0.25;

      const score = (greenPower - redPower) * 0.5 * adaptFactor + (meanVal - 128) * 0.05;
      const confidence = Math.min(99, Math.abs(score) * 1.3 + 50);
      const decision = score > 0 ? "üìà COMPRA (BUY)" : "üìâ VENTA (SELL)";
      const color = score > 0 ? "#22c55e" : "#ef4444";
      const arrow = score > 0 ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";

      // Estimar duraci√≥n y riesgo
      const duration = Math.floor(Math.random() * 10) + 3; // 3‚Äì12 min
      const risk = confidence > 80 ? "Bajo" : confidence > 65 ? "Medio" : "Alto";
      const riskColor = risk === "Bajo" ? "#22c55e" : risk === "Medio" ? "#eab308" : "#ef4444";

      memory.push(score > 0 ? 1 : -1);
      if (memory.length > 5) memory.shift();

      // Mostrar resultado 1 s despu√©s
      setTimeout(() => {
        result.innerHTML = `
          <div class="arrow" style="color:${color};">${arrow}</div>
          <p><b>Resultado del an√°lisis:</b></p>
          <p style="color:${color}; font-size:26px;">${decision}</p>
          <p>‚è±Ô∏è Duraci√≥n estimada: <b>${duration} min</b></p>
          <p>üéØ Nivel de riesgo: <b style="color:${riskColor};">${risk}</b></p>
          <p>Confianza: <b>${confidence.toFixed(1)}%</b></p>
          <p style="color:#94a3b8">(IA adaptativa ajusta decisiones seg√∫n historial reciente)</p>
        `;
      }, 1000);
    }
  </script>
</body>
</html>
