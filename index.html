<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trading Analyzer ‚Äî Agresivo</title>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
  body{background:#0f172a;color:#e6eef8;font-family:Inter,Arial;margin:0;padding:20px;text-align:center}
  .card{background:#111827;border-radius:12px;padding:20px;max-width:720px;margin:18px auto;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  button{background:#ef4444;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
  #progress{height:10px;background:#0b1220;border-radius:8px;overflow:hidden;margin-top:12px}
  #bar{height:100%;width:0%;background:linear-gradient(90deg,#f97316,#f43f5e);transition:width .3s}
  #status{margin-top:14px;color:#9aa4b2}
  #result{margin-top:18px;font-size:20px}
  .arrow{font-size:60px;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h2>Modo <strong>Agresivo</strong></h2>
    <p>Detecta cambios r√°pidos ‚Äî duraci√≥n estimada corta (1‚Äì5 min)</p>
    <input id="imageInput" type="file" accept="image/*"><br><br>
    <button id="btn" disabled>Analizar (15s)</button>
    <div id="progress"><div id="bar"></div></div>
    <div id="status">Cargando OpenCV...</div>
    <div id="result"></div>
  </div>

<script>
const btn = document.getElementById('btn');
const bar = document.getElementById('bar');
const status = document.getElementById('status');
const result = document.getElementById('result');

cv['onRuntimeInitialized'] = ()=> {
  status.textContent = 'OpenCV listo ‚úÖ';
  btn.disabled = false;
};

btn.addEventListener('click', async ()=>{
  const input = document.getElementById('imageInput');
  if(!input.files[0]) { status.textContent = 'Sube una imagen antes.'; return; }
  // reset UI
  result.innerHTML = '';
  bar.style.width = '0%';
  status.textContent = '‚è≥ An√°lisis en curso (15s)...';
  btn.disabled = true;

  // progress 15s -> 100 steps
  let p = 0;
  const tick = 150; // 150ms * 100 = 15000 ms
  const interval = setInterval(()=>{ p++; bar.style.width = Math.min(100,p)+'%'; if(p>=100) clearInterval(interval); }, tick);

  const img = new Image();
  img.src = URL.createObjectURL(input.files[0]);
  img.onload = ()=> {
    const canvas = document.createElement('canvas');
    canvas.width = img.width; canvas.height = img.height;
    const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0);

    // ejecutar an√°lisis despu√©s de 15s
    setTimeout(()=> {
      try {
        // lectura b√°sica HSV
        let src = cv.imread(canvas);
        let blur = new cv.Mat(); cv.GaussianBlur(src, blur, new cv.Size(3,3), 0);
        let hsv = new cv.Mat(); cv.cvtColor(blur, hsv, cv.COLOR_RGBA2HSV);
        let channels = new cv.MatVector(); cv.split(hsv, channels);
        let hue = channels.get(0), sat = channels.get(1), val = channels.get(2);
        const meanHue = cv.mean(hue)[0], meanSat = cv.mean(sat)[0], meanVal = cv.mean(val)[0];

        // AGRESIVO: umbrales suaves -> detecta incluso sutiles verdes/rojos
        const greenScore = (meanHue >= 30 && meanHue <= 95) ? meanSat : 0;
        const redScore = (meanHue <= 20 || meanHue >= 160) ? meanSat : 0;
        // tendencia r√°pida: usar variance de valor para "volatilidad"
        const vol = cv.meanStdDev(val)[1][0];

        // score combinado (ponderar color fuertemente)
        const score = (greenScore - redScore) * 0.7 + (meanVal - 128) * 0.05 + vol * 0.02;
        const conf = Math.min(99, Math.round(Math.abs(score)/2 + 60));
        const decision = score > 0 ? 'üìà COMPRA (BUY)' : 'üìâ VENTA (SELL)';
        const dir = score > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
        // Duraci√≥n agresiva: 1-5 min, inclinada a corto
        const duration = Math.max(1, Math.round(Math.abs(score) % 5) || 2);

        // liberar mats
        src.delete(); blur.delete(); hsv.delete(); channels.delete(); hue.delete(); sat.delete(); val.delete();

        // mostrar 1s despu√©s
        setTimeout(()=>{
          status.textContent = 'An√°lisis completado';
          result.innerHTML = `<div class="arrow">${dir}</div><div><strong style="font-size:20px">${decision}</strong></div><div style="margin-top:6px">Subir√°/Bajar√° pr√≥ximamente (${duration} min)</div><div style="color:#9aa4b2;margin-top:6px">Confianza: ${conf}%</div>`;
          btn.disabled = false;
        }, 1000);

      } catch(e){
        status.textContent = 'Error en an√°lisis: ' + e.message;
        btn.disabled = false;
      }
    }, 15000);
  };
});
</script>
</body>
</html>
