<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal Trading - Simulador</title>
<style>
body {
  background: #0f172a;
  color: #e2e8f0;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
}
header {
  background: #1e293b;
  padding: 15px;
  text-align: center;
  font-size: 1.3em;
  font-weight: bold;
  color: #38bdf8;
}
.container {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 10px;
  padding: 10px;
}
canvas {
  background: #1e293b;
  border-radius: 10px;
  width: 100%;
  height: 400px;
}
.controls {
  background: #1e293b;
  border-radius: 10px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.controls label {
  font-size: 0.9em;
  color: #94a3b8;
}
button {
  background: #38bdf8;
  color: #0f172a;
  font-weight: bold;
  border: none;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}
button:hover { background: #0ea5e9; }
.log {
  background: #0f172a;
  border-top: 1px solid #1e293b;
  padding: 10px;
  height: 150px;
  overflow-y: auto;
  font-size: 0.85em;
}
.green { color: #22c55e; }
.red { color: #ef4444; }
</style>
</head>
<body>
<header>📈 Signal Trading - Simulador Avanzado</header>
<div class="container">
  <div>
    <canvas id="chart"></canvas>
    <div id="summary" style="padding:10px;"></div>
  </div>
  <div class="controls">
    <label>Velocidad de Análisis:
      <select id="mode">
        <option value="agresivo">Agresivo</option>
        <option value="equilibrado" selected>Equilibrado</option>
        <option value="conservador">Conservador</option>
      </select>
    </label>
    <label>EMA Corta: <input id="emaShort" type="number" value="7"></label>
    <label>EMA Larga: <input id="emaLong" type="number" value="21"></label>
    <label>RSI Periodo: <input id="rsiP" type="number" value="14"></label>
    <label>MACD Lento: <input id="macdSlow" type="number" value="26"></label>
    <button id="runAnalysis">Ejecutar Análisis</button>
    <button id="backtestBtn">Backtest Local</button>
    <button id="downloadReport">Descargar Reporte</button>
    <button id="downloadCSV">Descargar CSV</button>
    <small id="timer"></small>
  </div>
</div>
<div class="log" id="log"></div>

<script>
/* ======== FUNCIONES DE INDICADORES ======== */
function EMA(data, period, accessor){
  const k = 2 / (period + 1);
  const emaArray = [];
  let emaPrev = accessor(data[0]);
  emaArray.push(emaPrev);
  for (let i = 1; i < data.length; i++) {
    const val = accessor(data[i]);
    emaPrev = val * k + emaPrev * (1 - k);
    emaArray.push(emaPrev);
  }
  return emaArray;
}

function RSI(data, period, accessor){
  let gains = 0, losses = 0;
  const result = [];
  for (let i = 1; i < data.length; i++){
    const diff = accessor(data[i]) - accessor(data[i - 1]);
    if (i <= period){
      if (diff >= 0) gains += diff; else losses -= diff;
      result.push(null);
      continue;
    }
    if (i === period + 1){
      let avgGain = gains / period;
      let avgLoss = losses / period;
      const rs = avgGain / avgLoss;
      result.push(100 - (100 / (1 + rs)));
    } else {
      const prev = result[result.length - 1];
      const gain = diff > 0 ? diff : 0;
      const loss = diff < 0 ? -diff : 0;
      gains = (gains * (period - 1) + gain) / period;
      losses = (losses * (period - 1) + loss) / period;
      const rs = gains / losses;
      result.push(100 - (100 / (1 + rs)));
    }
  }
  result.unshift(null);
  return result;
}

function MACD(data, fast, slow, signal, accessor){
  const emaFast = EMA(data, fast, accessor);
  const emaSlow = EMA(data, slow, accessor);
  const macdLine = emaFast.map((v, i) => v - emaSlow[i]);
  const signalLine = EMA(macdLine.map(v => ({v})), signal, d => d.v);
  const hist = macdLine.map((v, i) => v - signalLine[i]);
  return { macdLine, signalLine, hist };
}

/* ======== FUNCIONES DE UTILIDAD ======== */
function clamp(n, min, max){ return Math.max(min, Math.min(n, max)); }
function log(msg){
  const el = document.getElementById('log');
  el.innerHTML += `<div>${new Date().toLocaleTimeString()} → ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}
function simulateProgress(ms){
  return new Promise(res=>setTimeout(res, ms));
}

/* ======== DIBUJAR GRÁFICO ======== */
function drawChart(canvasId, data, ema, signals){
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.clientWidth;
  const h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  const closes = data.map(d => d.close);
  const max = Math.max(...closes);
  const min = Math.min(...closes);
  const range = max - min;
  const top = max + range * 0.05;
  const bottom = min - range * 0.05;

  ctx.strokeStyle = "#38bdf8";
  ctx.beginPath();
  closes.forEach((c, i) => {
    const x = i / (closes.length - 1) * (w - 40) + 20;
    const y = (top - c) / (top - bottom) * (h - 20) + 10;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // EMAs
  if (ema.emaShort){
    ctx.strokeStyle = "#22c55e";
    ctx.beginPath();
    ema.emaShort.forEach((c, i) => {
      const x = i / (closes.length - 1) * (w - 40) + 20;
      const y = (top - c) / (top - bottom) * (h - 20) + 10;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }
  if (ema.emaLong){
    ctx.strokeStyle = "#ef4444";
    ctx.beginPath();
    ema.emaLong.forEach((c, i) => {
      const x = i / (closes.length - 1) * (w - 40) + 20;
      const y = (top - c) / (top - bottom) * (h - 20) + 10;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }

  // Señales BUY / SELL
  if (signals && signals.length){
    for (const s of signals){
      const idx = s.idx;
      if (idx < 0 || idx >= closes.length) continue;
      const x = idx / (closes.length - 1) * (w - 40) + 20;
      const y = (top - closes[idx]) / (top - bottom) * (h - 20) + 10;
      ctx.beginPath();
      if (s.type === 'BUY'){ ctx.fillStyle = '#22c55e'; ctx.arc(x, y - 8, 6, 0, Math.PI * 2); ctx.fill(); }
      if (s.type === 'SELL'){ ctx.fillStyle = '#ef4444'; ctx.arc(x, y + 8, 6, 0, Math.PI * 2); ctx.fill(); }
    }
  }
}

/* ======== LÓGICA DE DECISIÓN (sin neutro) ======== */
function decideFromIndicators(data, params){
  const closeAccessor = d => d.close;
  const emaShort = EMA(data, params.emaShort, closeAccessor);
  const emaLong = EMA(data, params.emaLong, closeAccessor);
  const rsi = RSI(data, params.rsiP, closeAccessor);
  const macd = MACD(data, params.emaShort, params.emaLong, params.macdSlow, closeAccessor);

  const returns = [];
  for (let i = 1; i < data.length; i++){
    returns.push((data[i].close - data[i-1].close) / data[i-1].close);
  }
  function rollingStd(arr, win){
    const o = [];
    for (let i=0;i<arr.length;i++){
      if (i<win-1) o.push(null);
      else {
        let s=0,m=0;
        for (let j=i-win+1;j<=i;j++) m+=arr[j];
        m/=win;
        for (let j=i-win+1;j<=i;j++){ const d=arr[j]-m; s+=d*d; }
        o.push(Math.sqrt(s/win));
      }
    }
    return o;
  }
  const vol = returns.length ? rollingStd(returns,10) : [];
  vol.unshift(null);

  let greenSeq=0,redSeq=0;
  for(let i=Math.max(0,data.length-20);i<data.length;i++){
    if(data[i].close>data[i].open)greenSeq++;
    else if(data[i].close<data[i].open)redSeq++;
  }

  const i = data.length - 1;
  const signals = [];

  const emaShortVal = emaShort[i], emaLongVal = emaLong[i];
  if (emaShortVal>emaLongVal) signals.push('BUY');
  else if (emaShortVal<emaLongVal) signals.push('SELL');

  const rsiVal = rsi[i];
  if (rsiVal<30) signals.push('BUY');
  else if (rsiVal>70) signals.push('SELL');

  const macdVal = macd.hist[i];
  if (macdVal>0) signals.push('BUY');
  else if (macdVal<0) signals.push('SELL');

  if (greenSeq>=3) signals.push('BUY');
  if (redSeq>=3) signals.push('SELL');

  let buyWeight=0,sellWeight=0;
  signals.forEach(s=>{ if(s==='BUY')buyWeight++; if(s==='SELL')sellWeight++; });

  if(params.mode==='agresivo'){ buyWeight*=1.2; sellWeight*=1.2; }
  if(params.mode==='conservador'){ buyWeight*=0.9; sellWeight*=0.9; }

  const final = buyWeight>=sellWeight ? 'COMPRAR' : 'VENDER';

  const volVal = vol[i];
  const conf = clamp(
    (Math.abs(buyWeight-sellWeight)/Math.max(1,buyWeight+sellWeight))*100*(1+((volVal||0)*100)),
    10,99
  );

  let duration='Indeterminado';
  if(conf>75)duration=params.mode==='agresivo'?'1-3 min':
                        params.mode==='equilibrado'?'3-10 min':'10-30 min';
  else if(conf>50)duration=params.mode==='agresivo'?'3-6 min':'5-15 min';
  else duration='Baja confianza';

  return {decision:final,confidence:Math.round(conf),duration};
}

/* ======== SIMULACIÓN PRINCIPAL ======== */
let loadedData = [];
for (let i=0;i<200;i++){
  loadedData.push({
    t:i,
    open:100+Math.sin(i/10)*5+Math.random()*2,
    close:100+Math.sin(i/10)*5+Math.random()*2,
  });
}

document.getElementById('runAnalysis').addEventListener('click', async ()=>{
  document.getElementById('timer').textContent='Analizando...';
  await simulateProgress(1500);
  const params={
    emaShort:Number(document.getElementById('emaShort').value),
    emaLong:Number(document.getElementById('emaLong').value),
    rsiP:Number(document.getElementById('rsiP').value),
    macdSlow:Number(document.getElementById('macdSlow').value),
    mode:document.getElementById('mode').value
  };
  const report=decideFromIndicators(loadedData,params);
  const signals=[];
  if(report.decision==='COMPRAR')signals.push({type:'BUY',idx:loadedData.length-1});
  else signals.push({type:'SELL',idx:loadedData.length-1});
  drawChart('chart',loadedData,{
    emaShort:EMA(loadedData,params.emaShort,d=>d.close),
    emaLong:EMA(loadedData,params.emaLong,d=>d.close)
  },signals);
  document.getElementById('summary').innerHTML=
    `Decisión: <b class="${report.decision==='COMPRAR'?'green':'red'}">${report.decision}</b> 
     (${report.confidence}% confianza, duración ${report.duration})`;
  log(`Decisión final: ${report.decision} (${report.confidence}% confianza)`);
  document.getElementById('timer').textContent='Listo';
});
</script>
</body>
</html>
