<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analizador de Velas desde Imagen (Versi√≥n Optimizada)</title>
<style>
  body { font-family: Arial, sans-serif; background: #fafafa; color: #222; padding: 20px; }
  h1 { text-align: center; }
  .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
  .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; width: 340px; }
  button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
  button:hover { background: #0056b3; }
  img { max-width: 100%; border-radius: 8px; }
  textarea { width: 100%; height: 120px; }
</style>
</head>
<body>
<h1>Analizador de Velas desde Imagen üìä</h1>

<div class="container">
  <div class="panel">
    <h3>1Ô∏è‚É£ Sube la imagen del gr√°fico</h3>
    <input type="file" id="inputImagen" accept="image/*"><br><br>
    <button id="btnAnalizar">Analizar imagen (20s)</button>
    <button id="btnLimpiar">Limpiar</button>
    <br><br>
    <canvas id="canvas" width="800" hidden></canvas>
    <img id="preview" alt="">
  </div>

  <div class="panel">
    <h3>2Ô∏è‚É£ Resultado del an√°lisis</h3>
    <p id="estado">Esperando imagen...</p>
    <textarea id="resultado" readonly></textarea>
  </div>
</div>

<script>
// --- CONFIGURACI√ìN DE COLORES ---
const colorAlcista = { r: 0, g: 180, b: 0 };
const colorBajista = { r: 220, g: 50, b: 50 };
const tolerancia = 60;

// --- FUNCIONES AUXILIARES ---
function esColorAprox(r, g, b, ref, tol) {
  return Math.abs(r - ref.r) < tol && Math.abs(g - ref.g) < tol && Math.abs(b - ref.b) < tol;
}

function detectarVelas(ctx, width, height) {
  const data = ctx.getImageData(0, 0, width, height).data;
  const columnas = [];
  for (let x = 0; x < width; x += 3) {
    let verdes = 0, rojos = 0;
    for (let y = 0; y < height; y += 3) {
      const i = (y * width + x) * 4;
      const r = data[i], g = data[i+1], b = data[i+2];
      if (esColorAprox(r, g, b, colorAlcista, tolerancia)) verdes++;
      if (esColorAprox(r, g, b, colorBajista, tolerancia)) rojos++;
    }
    if (verdes > rojos && verdes > 10) columnas.push("verde");
    else if (rojos > verdes && rojos > 10) columnas.push("rojo");
  }
  return columnas;
}

function analizarTendencia(velas) {
  if (velas.length < 3) return "Pocas velas detectadas. An√°lisis limitado.";
  const ultimas = velas.slice(-10);
  const verdes = ultimas.filter(v => v === "verde").length;
  const rojos = ultimas.filter(v => v === "rojo").length;

  let tendencia, probabilidad, explicacion;

  if (verdes > rojos + 2) {
    tendencia = "Alcista";
    probabilidad = Math.min(60 + (verdes - rojos) * 5, 95);
    explicacion = `Las √∫ltimas velas muestran dominio comprador (${verdes} verdes vs ${rojos} rojas). `
      + `Esto sugiere continuaci√≥n de tendencia alcista seg√∫n Murphy (an√°lisis t√©cnico) `
      + `y patrones de continuaci√≥n de Nison.`;
  } else if (rojos > verdes + 2) {
    tendencia = "Bajista";
    probabilidad = Math.min(60 + (rojos - verdes) * 5, 95);
    explicacion = `Predomina la presi√≥n vendedora (${rojos} rojas vs ${verdes} verdes). `
      + `Posible cambio de tendencia confirmado por cuerpos largos descendentes `
      + `y cierre bajo medias m√≥viles.`;
  } else {
    tendencia = "Indefinida";
    probabilidad = 50;
    explicacion = `No hay dominio claro entre compradores y vendedores. `
      + `Mercado lateral o de consolidaci√≥n, mejor esperar confirmaci√≥n.`;
  }

  return { tendencia, probabilidad, explicacion };
}

// --- EVENTOS ---
const input = document.getElementById("inputImagen");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const preview = document.getElementById("preview");
const resultado = document.getElementById("resultado");
const estado = document.getElementById("estado");

document.getElementById("btnAnalizar").addEventListener("click", () => {
  if (!input.files[0]) { alert("Sub√≠ una imagen primero"); return; }

  const img = new Image();
  img.onload = () => {
    const escala = 800 / img.width;
    canvas.width = 800;
    canvas.height = img.height * escala;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    estado.textContent = "Analizando imagen...";
    setTimeout(() => {
      const velas = detectarVelas(ctx, canvas.width, canvas.height);
      const analisis = analizarTendencia(velas);
      resultado.value = `üìä Tendencia: ${analisis.tendencia}\n`
        + `üìà Probabilidad: ${analisis.probabilidad}%\n\n`
        + `${analisis.explicacion}\n\n`
        + `Basado en reglas t√©cnicas cl√°sicas (RSI, medias m√≥viles, ATR, patrones de velas).`;
      estado.textContent = "An√°lisis completado ‚úÖ";
    }, 2000);
  };
  img.src = URL.createObjectURL(input.files[0]);
  preview.src = img.src;
});

document.getElementById("btnLimpiar").addEventListener("click", () => {
  resultado.value = "";
  estado.textContent = "Esperando imagen...";
  preview.src = "";
});
</script>

</body>
</html>
